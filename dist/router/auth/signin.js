'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _koaRouter=require('koa-router');var _koaRouter2=_interopRequireDefault(_koaRouter);var _boom=require('boom');var _boom2=_interopRequireDefault(_boom);var _koaJwt=require('koa-jwt');var _koaJwt2=_interopRequireDefault(_koaJwt);var _koaConvert=require('koa-convert');var _koaConvert2=_interopRequireDefault(_koaConvert);var _koaReqValidator=require('koa-req-validator');var _koaReqValidator2=_interopRequireDefault(_koaReqValidator);var _users=require('../../models/users');var _users2=_interopRequireDefault(_users);var _auth=require('../../utils/auth');var _mixed=require('../../utils/mixed');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}var validate=function validate(){return(0,_koaConvert2.default)(_koaReqValidator2.default.apply(undefined,arguments))};var router=new _koaRouter2.default({prefix:'/v1/signin'});router.post('/',validate({'email:body':['require','isEmail','Format of email address is wrong'],'password:body':['require','Password is required']}),function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(ctx,next){var _ctx$request$body,email,password,socialAccountExist,user,isPassword,userId,token;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_ctx$request$body=ctx.request.body,email=_ctx$request$body.email,password=_ctx$request$body.password;_context.next=4;return _users2.default.findOne({email:email,social:true});case 4:socialAccountExist=_context.sent;if(!socialAccountExist){_context.next=7;break}throw _boom2.default.create(403,'The email has already been registered in social account',{code:403001});case 7:_context.next=9;return _users2.default.findOne({email:email});case 9:user=_context.sent;if(user){_context.next=12;break}throw _boom2.default.create(401,'Email or password is not valid',{code:401001});case 12:if(!(user.isEmailActived===false)){_context.next=14;break}throw _boom2.default.create(404,'Your email account is not activated',{code:404001});case 14:_context.next=16;return user.validatePassword(password);case 16:isPassword=_context.sent;if(isPassword){_context.next=19;break}throw _boom2.default.create(401,'Email or password is not valid',{code:401001});case 19:userId=user._id;token=_auth.getToken['JWT']({userId:userId,email:email});ctx.body={status:'success',auth:_extends({token:token},(0,_mixed.getCleanUser)(user)),code:200003,message:'Signin success'};_context.next=27;break;case 24:_context.prev=24;_context.t0=_context['catch'](0);if(_context.t0.output.statusCode){ctx.throw(_context.t0.output.statusCode,_context.t0)}else{ctx.throw(500,_context.t0)}case 27:case'end':return _context.stop();}}},_callee,undefined,[[0,24]])}));return function(_x,_x2){return _ref.apply(this,arguments)}}());exports.default=router;