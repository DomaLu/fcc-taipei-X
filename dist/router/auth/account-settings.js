'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _koaRouter=require('koa-router');var _koaRouter2=_interopRequireDefault(_koaRouter);var _boom=require('boom');var _boom2=_interopRequireDefault(_boom);var _koaConvert=require('koa-convert');var _koaConvert2=_interopRequireDefault(_koaConvert);var _koaReqValidator=require('koa-req-validator');var _koaReqValidator2=_interopRequireDefault(_koaReqValidator);var _lodash=require('lodash');var _lodash2=_interopRequireDefault(_lodash);var _users=require('../../models/users');var _users2=_interopRequireDefault(_users);var _mixed=require('../../utils/mixed');var _email=require('../../utils/email');var _config=require('../../config');var _config2=_interopRequireDefault(_config);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}/*
  account-settings (!!!此 component 頁面可跟 register component 頁面共用，差別在於 email 不能改)
  (1) Login => jwt token
  (2) 才能到修改頁面 (setting) => 可改 nickname (60 days), photo, password
  (3) Submit to server + email to user with modify password (no URL)
*/var validate=function validate(){return(0,_koaConvert2.default)(_koaReqValidator2.default.apply(undefined,arguments))};var router=new _koaRouter2.default({prefix:'/v1/account_settings'});router.post('/',validate({'nickname:body':['require','isAlphanumeric','nickname is required or not alphanumeric'],'email:body':['require','isEmail','email is required or not valid'],'password:body':['require','password is required'],'photo:body':['require','isDataURI','photo is required or not dataURI']}),function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(ctx,next){var _ctx$request$body,email,nickname,password,photo,result,user,oldNickname;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_ctx$request$body=ctx.request.body,email=_ctx$request$body.email,nickname=_ctx$request$body.nickname,password=_ctx$request$body.password,photo=_ctx$request$body.photo;_context.next=4;return _users2.default.findOne({email:email});case 4:result=_context.sent;if(result){_context.next=7;break}throw _boom2.default.notFound('user not found');case 7:user=void 0;oldNickname=result.nickname;//如果 user 有嘗試改動 nickname
if(!(oldNickname!==nickname)){_context.next=20;break}_context.next=12;return _users2.default.findById(result._id).where('nicknameChangeLimit').lt(Date.now());case 12:user=_context.sent;if(user){_context.next=15;break}throw _boom2.default.forbidden('nickname 60 days limit');case 15://除了改動 nickname、password 與 photo 外，也要重設 60 days 限制
_lodash2.default.extend(user,{nickname:nickname,password:password,photo:photo,nicknameChangeLimit:_config2.default.dbSchema.user.nicknameChangeLimit()});_context.next=18;return user.save();case 18:_context.next=26;break;case 20:_context.next=22;return _users2.default.findById(result._id);case 22:user=_context.sent;_lodash2.default.extend(user,{password:password,photo:photo});_context.next=26;return user.save();case 26:ctx.state.user=user;_context.next=29;return(0,_email.mailTransport)(ctx.request.body);case 29:ctx.state.nodemailerInfo=_context.sent;_context.next=32;return next();case 32:_context.next=37;break;case 34:_context.prev=34;_context.t0=_context['catch'](0);if(_context.t0.output.statusCode){ctx.throw(_context.t0.output.statusCode,_context.t0)}else{ctx.throw(500,_context.t0)}case 37:case'end':return _context.stop();}}},_callee,undefined,[[0,34]])}));return function(_x,_x2){return _ref.apply(this,arguments)}}(),_email.checkEmailStatus);exports.default=router;