'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _koaRouter=require('koa-router');var _koaRouter2=_interopRequireDefault(_koaRouter);var _boom=require('boom');var _boom2=_interopRequireDefault(_boom);var _lodash=require('lodash');var _lodash2=_interopRequireDefault(_lodash);var _koaConvert=require('koa-convert');var _koaConvert2=_interopRequireDefault(_koaConvert);var _koaReqValidator=require('koa-req-validator');var _koaReqValidator2=_interopRequireDefault(_koaReqValidator);var _posts=require('../../models/posts');var _posts2=_interopRequireDefault(_posts);var _mixed=require('../../utils/mixed');var _config=require('../../config');var _config2=_interopRequireDefault(_config);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}var validate=function validate(){return(0,_koaConvert2.default)(_koaReqValidator2.default.apply(undefined,arguments))};var router=new _koaRouter2.default({prefix:'/v1/posts'});router.post('/',validate({'title:body':['require','title is required or not valid'],'content:body':['require','content is required or not valid']}),function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(ctx,next){var authorization,_ref2,userId,_ref3,findUser,canPost,user,article,post;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;// 從 token 找回 user id
authorization=ctx.request.header.authorization;_context.next=4;return(0,_mixed.checkAuth)(authorization);case 4:_ref2=_context.sent;userId=_ref2.userId;if(userId){_context.next=8;break}throw _boom2.default.create(401,'Token is not valid or expired',{code:401002});case 8:_context.next=10;return(0,_mixed.canPostArticle)(userId);case 10:_ref3=_context.sent;findUser=_ref3.findUser;canPost=_ref3.canPost;user=(0,_mixed.getCleanUser)(findUser);if(canPost){_context.next=16;break}throw _boom2.default.create(403,'You can\'t repeatly post article in '+_config2.default.user.createdPostTime,{code:403003,create_post_time:user.create_post_time});case 16:article=_extends({author:userId},ctx.request.body);_lodash2.default.extend(canPost,{createdPostLimit:_config2.default.user.createdPostLimit()});_context.next=20;return canPost.save();case 20:post=new _posts2.default(article);_context.next=23;return post.save();case 23:_context.next=25;return post.populate('author').execPopulate();case 25:ctx.body={status:'success',code:200004,post:(0,_mixed.getCleanPost)(post)};_context.next=31;break;case 28:_context.prev=28;_context.t0=_context['catch'](0);if(_context.t0.output&&_context.t0.output.statusCode){ctx.throw(_context.t0.output.statusCode,_context.t0)}else{ctx.throw(500,_context.t0)}case 31:case'end':return _context.stop();}}},_callee,undefined,[[0,28]])}));return function(_x,_x2){return _ref.apply(this,arguments)}}());router.get('/findPresent',function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(ctx,next){var count,posts;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;count=_config2.default.user.loadPostCount();_context2.next=4;return _posts2.default.find().sort('-createdAt').limit(count).deepPopulate('author comments.author');case 4:posts=_context2.sent;ctx.body={status:'success',code:200006,posts:posts.map(function(post){return(0,_mixed.getCleanPost)(post)})};_context2.next=11;break;case 8:_context2.prev=8;_context2.t0=_context2['catch'](0);if(_context2.t0.output.statusCode){ctx.throw(_context2.t0.output.statusCode,_context2.t0)}else{ctx.throw(500,_context2.t0)}case 11:case'end':return _context2.stop();}}},_callee2,undefined,[[0,8]])}));return function(_x3,_x4){return _ref4.apply(this,arguments)}}());router.get('/findOlder',validate({'postID:query':['isMongoId','Invalid postID']}),function(){var _ref5=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(ctx,next){var count,postID,posts;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;count=_config2.default.user.loadPostCount();postID=ctx.request.query.postID;_context3.next=5;return _posts2.default.find().where('_id').lt(postID).sort('-createdAt').limit(count).deepPopulate('author comments.author');case 5:posts=_context3.sent;ctx.body={status:'success',code:200006,posts:posts.map(function(post){return(0,_mixed.getCleanPost)(post)})};_context3.next=12;break;case 9:_context3.prev=9;_context3.t0=_context3['catch'](0);if(_context3.t0.output.statusCode){ctx.throw(_context3.t0.output.statusCode,_context3.t0)}else{ctx.throw(500,_context3.t0)}case 12:case'end':return _context3.stop();}}},_callee3,undefined,[[0,9]])}));return function(_x5,_x6){return _ref5.apply(this,arguments)}}());router.get('/findNewer',validate({'postID:query':['isMongoId','Invalid postID']}),function(){var _ref6=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(ctx,next){var count,postID,posts;return regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;count=_config2.default.user.loadPostCount();postID=ctx.request.query.postID;_context4.next=5;return _posts2.default.find().where('_id').gt(postID).sort('createdAt').limit(count).deepPopulate('author comments.author');case 5:posts=_context4.sent;posts.sort(function(a,b){return a._id<b._id});ctx.body={status:'success',code:200006,posts:posts.map(function(post){return(0,_mixed.getCleanPost)(post)})};_context4.next=13;break;case 10:_context4.prev=10;_context4.t0=_context4['catch'](0);if(_context4.t0.output.statusCode){ctx.throw(_context4.t0.output.statusCode,_context4.t0)}else{ctx.throw(500,_context4.t0)}case 13:case'end':return _context4.stop();}}},_callee4,undefined,[[0,10]])}));return function(_x7,_x8){return _ref6.apply(this,arguments)}}());router.patch('/:postID',validate({'postID:params':['require','isMongoId','Invalid postID']}),function(){var _ref7=_asyncToGenerator(regeneratorRuntime.mark(function _callee5(ctx,next){var authorization,_ref8,userId,postID,article,author,updatedPost;return regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;// 從 token 找回 user id
authorization=ctx.request.header.authorization;_context5.next=4;return(0,_mixed.checkAuth)(authorization);case 4:_ref8=_context5.sent;userId=_ref8.userId;if(userId){_context5.next=8;break}throw _boom2.default.create(401,'Token is not valid or expired',{code:401002});case 8:// 檢查 postID 是否存在
postID=ctx.params.postID;_context5.next=11;return _posts2.default.findById(postID);case 11:article=_context5.sent;if(article){_context5.next=14;break}throw _boom2.default.create(404,'This post is not exist',{code:404003});case 14:// 只有作者本人才可編輯文章
author=article.author;author=author.toString();if(!(author!==userId)){_context5.next=18;break}throw _boom2.default.create(403,'Edit other people\'s post is not allowed',{code:403004});case 18:_context5.next=20;return _posts2.default.findByIdAndUpdate(postID,ctx.request.body,{new:true});case 20:updatedPost=_context5.sent;_context5.next=23;return updatedPost.populate('author').execPopulate();case 23:ctx.body={status:'success',code:200007,post:(0,_mixed.getCleanPost)(updatedPost)};_context5.next=29;break;case 26:_context5.prev=26;_context5.t0=_context5['catch'](0);if(_context5.t0.output&&_context5.t0.output.statusCode){ctx.throw(_context5.t0.output.statusCode,_context5.t0)}else{ctx.throw(500,_context5.t0)}case 29:case'end':return _context5.stop();}}},_callee5,undefined,[[0,26]])}));return function(_x9,_x10){return _ref7.apply(this,arguments)}}());router.delete('/:postID',validate({'postID:params':['require','isMongoId','Invalid postID']}),function(){var _ref9=_asyncToGenerator(regeneratorRuntime.mark(function _callee6(ctx,next){var authorization,_ref10,userId,postID,article,author,updatedPost;return regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.prev=0;// 從 token 找回 user id
authorization=ctx.request.header.authorization;_context6.next=4;return(0,_mixed.checkAuth)(authorization);case 4:_ref10=_context6.sent;userId=_ref10.userId;if(userId){_context6.next=8;break}throw _boom2.default.create(401,'Token is not valid or expired',{code:401002});case 8:// 檢查 postID 是否存在
postID=ctx.params.postID;_context6.next=11;return _posts2.default.findById(postID);case 11:article=_context6.sent;if(article){_context6.next=14;break}throw _boom2.default.create(404,'This post is not exist',{code:404003});case 14:// 只有作者本人才可刪除文章
author=article.author;author=author.toString();if(!(author!==userId)){_context6.next=18;break}throw _boom2.default.create(403,'Delete other people\'s post is not allowed',{code:403005});case 18:_context6.next=20;return _posts2.default.findByIdAndRemove(postID);case 20:updatedPost=_context6.sent;_context6.next=23;return updatedPost.populate('author').execPopulate();case 23:ctx.body={status:'success',code:200008,post:(0,_mixed.getCleanPost)(updatedPost)};_context6.next=29;break;case 26:_context6.prev=26;_context6.t0=_context6['catch'](0);if(_context6.t0.output&&_context6.t0.output.statusCode){ctx.throw(_context6.t0.output.statusCode,_context6.t0)}else{ctx.throw(500,_context6.t0)}case 29:case'end':return _context6.stop();}}},_callee6,undefined,[[0,26]])}));return function(_x11,_x12){return _ref9.apply(this,arguments)}}());exports.default=router;