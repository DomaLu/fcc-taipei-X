'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.default=function(io){var _this=this;var postTimeIO=io.of('/postTime');postTimeIO.on('connection',function(socket){var socketID=socket.id;socket.on('storeClientInfo',function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(_ref2){var token=_ref2.token;var _ref3,userId,email;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return(0,_auth.verifyToken)(token);case 3:_ref3=_context.sent;userId=_ref3.userId;email=_ref3.email;if(list[userId]===undefined){list[userId]={sockets:[],userInfo:{email:null}}}list[userId].sockets.push(socket);list[userId].userInfo.email=email;socket.join(userId);socket.broadcast.to(userId).emit('rooms','socket '+socket.id+' \u9032\u5165\u4E86\u623F\u9593');//console.log(util.inspect(list, { showHidden: false, depth: 3 }))
_context.next=17;break;case 13:_context.prev=13;_context.t0=_context['catch'](0);console.log('socket.io storeClientInfo error');console.log(_context.t0);case 17:case'end':return _context.stop();}}},_callee,_this,[[0,13]])}));return function(_x){return _ref.apply(this,arguments)}}());socket.on('disconnect',function(){try{var userId=removeSocketID(list,socketID);socket.leave(userId);socket.broadcast.to(userId).emit('rooms','socket '+socket.id+' \u9000\u51FA\u4E86\u623F\u9593')}catch(e){console.log('socket.io disconnect error');console.log(e)}});socket.on('post',function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(_ref5){var token=_ref5.token;var _ref6,userId,create_post_time;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return(0,_auth.verifyToken)(token);case 3:_ref6=_context2.sent;userId=_ref6.userId;_context2.next=7;return(0,_mixed.getCreatePostTime)(userId);case 7:create_post_time=_context2.sent;postTimeIO.in(userId).emit('postTime',{msg:'You can not post article in 3 minutes',create_post_time:create_post_time});_context2.next=15;break;case 11:_context2.prev=11;_context2.t0=_context2['catch'](0);console.log('socket.io post error');console.log(_context2.t0);case 15:case'end':return _context2.stop();}}},_callee2,_this,[[0,11]])}));return function(_x2){return _ref4.apply(this,arguments)}}())})};var _util=require('util');var _util2=_interopRequireDefault(_util);var _auth=require('../utils/auth');var _mixed=require('../utils/mixed');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}var list={};var removeSocketID=function removeSocketID(list,socketID){var _userID=void 0;Object.keys(list).forEach(function(userID){list[userID].sockets=list[userID].sockets.filter(function(socket){if(socket.id!==socketID){return true}_userID=userID});if(list[userID].sockets.length===0){delete list[userID]}});return _userID};